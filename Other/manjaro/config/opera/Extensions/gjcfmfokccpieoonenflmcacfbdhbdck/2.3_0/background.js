let s_=null,data=null,cl_=0,safe_={},pt=chrome.i18n.getMessage('v7add');chrome.runtime.onInstalled.addListener(f=>{s_=[],data={op1:0,op2:0,op3:0,op4:0,op5:0,op6:0,op7:0,op8:0,op9:0},'install'===f.reason&&(chrome.storage.local.set({s_:s_},()=>{chrome.runtime.getPlatformInfo(g=>{'mac'===g.os&&(data.op8=1),chrome.storage.local.set({data:data},()=>{chrome.runtime.openOptionsPage()})})}),chrome.storage.local.set({trash:[]})),'update'===f.reason&&chrome.storage.local.get(['stash','s_','slike','data'],g=>{let h=g.stash,k=g.s_,l=g.slike,n=g.data;if(!(k==void 0)){if('op9'in n)return;n.op9=0,data=n,chrome.storage.local.set({data:data},()=>{chrome.runtime.sendMessage({rf_:1}),chrome.tabs.create({url:'options.html#1'})})}else if(h){let q=h.slice(0),v=[],w={},x=[];export_old(q);for(let y=h.length-1;0<=y;y--){let A=new Date(h[y].date.split('/').reverse().map(C=>C.trim()).join('-')).getTime(),B={t:h[y].nam,u:h[y].url,i:'../img/def.png',v:A,p:0};v[v.length]=B}for(let A,y=v.length-1;0<=y;y--)A=v[y].u,w[A]||(w[A]=1,x[x.length]=v[y]);x.sort(function(y,A){return y.v-A.v}),chrome.storage.local.set({s_:x},()=>{chrome.runtime.getPlatformInfo(y=>{'mac'===y.os&&(data.op8=1),chrome.storage.local.set({data:data},()=>{chrome.tabs.create({url:'options.html#1'})})})}),chrome.storage.local.set({trash:[]}),chrome.storage.local.remove('slike',()=>{let y=chrome.runtime.lastError;y&&console.error(y)})}else console.log('error on update - can\'t find old stash')})});const _rT=()=>{chrome.tabs.query({},f=>{for(let g=f.length-1;0<=g;g--)f[g].url.startsWith('chrome://')||_aI(f[g].url,f[g].id)})},_aI=(f,g)=>{let h=0,k=0;if(!f.startsWith('chrome://')){for(let l=s_.length-1;0<=l;l--)if(s_[l].u===f){h=1,s_[l].p||(s_[l].p=1,k=s_[l].u);break}h?_zel(g):_siv(g),k&&(_save(),chrome.runtime.sendMessage({vis:k,s:s_}))}},_fT=(f,g)=>{f.startsWith('chrome://')||chrome.tabs.query({},h=>{for(let k=h.length-1;0<=k;k--)f===h[k].url&&(g?_siv(h[k].id):_zel(h[k].id))})},_zel=f=>{chrome.pageAction.setIcon({tabId:f,path:'img/stX.svg'}),chrome.pageAction.setTitle({tabId:f,title:chrome.i18n.getMessage('v7remove')}),chrome.pageAction.show(f)},_siv=f=>{chrome.pageAction.setIcon({tabId:f,path:'img/st.svg'}),chrome.pageAction.setTitle({tabId:f,title:chrome.i18n.getMessage('v7add')}),chrome.pageAction.show(f)},_tu=(f,g,h)=>{'loading'===g.status?g.url?(_aI(h.url,f),delete safe_[f]):safe_[f]=1:'complete'===g.status&&safe_[f]&&(delete safe_[f],_aI(h.url,f))},_pc=f=>{let g=Date.now();600<g-cl_&&(cl_=g,_pa_ctx(f.url,f.id,f.title,f.favIconUrl))},_pa_ctx=(f,g,h,k)=>{chrome.pageAction.getTitle({tabId:g},l=>{if(l)if(l!==pt){_fT(f,1);for(let n=s_.length-1;0<=n;n--)s_[n].u===f&&s_.splice(n,1);chrome.runtime.sendMessage({ukloni:f,s:s_}),_save()}else if(_fT(f),f.startsWith('https://www.youtube.com')){let n=/(?:[?&]vi?=|\/embed\/|\/\d\d?\/|\/vi?\/|https?:\/\/(?:www\.)?youtu\.be\/)([^&\n?#]+)/,q=f.match(n);if(q&&q[1]){let v='http://img.youtube.com/vi/'+q[1]+'/0.jpg';_aN(h,f,v)}else _inj(h,f,g,k)}else _inj(h,f,g,k)})},_inj=(f,g,h,k)=>{chrome.tabs.executeScript(h,{code:'metaA =  document.querySelectorAll(\''+'meta[property="og:image"]'+'\'); ctn = 0;\t\tif (metaA[0]) chrome.runtime.sendMessage( {img: metaA[0].content});\t\telse {\t\t\tlet sk=null,sl=document.images;\t\t\tfor (let i=0,l=sl.length;i<l;i++) {\t\t\t\tif(ctn>30)break;\t\t\t\tif(sl[i].width>150 && sl[i].height>150) {\t\t\t\t\tctn++;\t\t\t\t\tsk=sl[i];\t\t\t\t\tif(sl[i].width>500 && sl[i].height>200) break;\t\t\t\t}\t\t\t}\t\t\tif(sk) chrome.runtime.sendMessage({img: sk.src});\t\t\telse chrome.runtime.sendMessage({img: \'../img/def.png\', img_e: 1});\t\t}\t\tmetaA = null;ctn = null;'},n=>{if(!n){console.log(chrome.runtime.lastError);let q='../img/def.png';k&&(q=k),_aN(f,g,k)}})},_aC=()=>{chrome.contextMenus.create({onclick:_cC,id:'v7_stash',title:chrome.i18n.getMessage('ctx'),contexts:['all']})};function _cC(f,g){f.pageUrl&&_pa_ctx(f.pageUrl,g.id,g.title,g.favIconUrl)}const _aN=(f,g,h)=>{let k=Date.now(),l={t:f,u:g,i:h,v:k,p:0};s_[s_.length]=l,_save(),chrome.runtime.sendMessage({dodaj:l,s:s_})},_aU=f=>{chrome.storage.local.get('trash',g=>{let h=g.trash;h=h.concat(f),chrome.storage.local.set({trash:h}),chrome.runtime.sendMessage({trashR:1})})},_e=()=>{let f={expDataType:'V7_Stash',version:'1.0',data:s_},g=JSON.stringify(f,null,4),h=URL.createObjectURL(new Blob([g],{type:'application/json'}));chrome.downloads.download({url:h,filename:'V7_Stash.json'})};chrome.runtime.onMessage.addListener((f,g)=>{if(f.img)f.img_e?g.tab.favIconUrl?_aN(g.tab.title,g.tab.url,g.tab.favIconUrl):_aN(g.tab.title,g.tab.url,f.img):_aN(g.tab.title,g.tab.url,f.img);else if(f.exp)_e();else if(f.oImp)s_=f.oImp,_rT(),_save();else if(f.delUrl)s_=f.s,_fT(f.delUrl,1),_save(),_aU(f.d_n);else if(f.delAll){let h=s_.slice(0);s_=[],chrome.tabs.query({},k=>{for(let l=k.length-1;0<=l;l--)k[l].url.startsWith('chrome://')||_siv(k[l].id)}),_save(),_aU(h)}else f.delVis?(s_=f.delVis,chrome.tabs.query({},h=>{for(let k=h.length-1;0<=k;k--){let l=1,n=h[k].url;if(!n.startsWith('chrome://')){for(let q=s_.length-1;0<=q;q--)s_[q].u===h[k].url&&(_zel(h[k].id),l=0);l&&_siv(h[k].id)}}}),_save(),_aU(f.d_v)):f.imgDrop?(s_=f.imgDrop,_save()):f.d_new?(data=f.d_new,chrome.storage.local.set({data:data})):f.d_ctx&&(f.d_true?_aC():chrome.contextMenus.removeAll())}),setTimeout(()=>{chrome.storage.local.get(['s_','data'],f=>{s_=f.s_||[],data=f.data||[],_rT(),data.op3&&_aC(),chrome.tabs.onUpdated.addListener(_tu),chrome.pageAction.onClicked.addListener(_pc),chrome.storage.local.set({trash:[]})})},1e3),chrome.commands.onCommand.addListener(f=>{'openTab'===f&&chrome.tabs.create({url:'tabGrid.html',active:!0})});const _save=()=>{chrome.storage.local.set({s_:s_})};function export_old(f){if(f){var g=f;g.unshift([]),g.unshift({expDataType:'V7 Stash2'});var k=JSON.stringify(g);dlFn('V7_stash_old.json',k)}else chrome.storage.local.get('stash',l=>{let n=l.stash;if(n){n.unshift([]),n.unshift({expDataType:'V7 Stash2'});var w=JSON.stringify(n);dlFn('V7_stash_old.json',w)}else console.log('Can\'t find old stash storage')})}function dlFn(f,g){var h=document.createElement('A'),k=new Blob([g],{type:'application/octet-stream'}),l=window.URL.createObjectURL(k);h.setAttribute('href',l),h.setAttribute('download',f),h.click()}